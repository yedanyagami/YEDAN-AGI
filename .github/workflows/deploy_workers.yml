name: YEDAN Deploy All Workers

on:
  push:
    branches: [main]
    paths:
      - '**_worker.js'
      - '*_webhook.js'
      - 'wrangler*.toml'
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy-workers:
    runs-on: ubuntu-latest
    name: Deploy Cloudflare Workers
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Payhip Notifier
        run: wrangler deploy --config wrangler.toml
        continue-on-error: true

      - name: Deploy Synapse API
        run: wrangler deploy --config wrangler_synapse.toml
        continue-on-error: true

      - name: Deploy Scam Guard API
        run: wrangler deploy --config wrangler_scamguard.toml
        continue-on-error: true

      - name: Notify Telegram
        if: always()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=ðŸš€ YEDAN Workers Deployed! Status: ${{ job.status }}" \
            -d "parse_mode=Markdown"
